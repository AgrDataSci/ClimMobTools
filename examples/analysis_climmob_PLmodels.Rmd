---
title: "Analyse the ClimMob tricot data with PlackettLuce models"
author: "KauÃª de Sousa"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

# Breadwheat data

Here I show an example using the `gosset::breadwheat` data. Which is a dataframe with data from crowdsourcing citizen-science trials of bread wheat (*Triticum aestivum*) varieties in India. 

```{r, message = FALSE}
#library("devtools")
#install_github("kauedesousa/gosset", upgrade = "never")
library("gosset")
library("PlackettLuce")
library("qvcalc")
library("tidyverse")
library("cowplot")

data("breadwheat", package = "gosset")

print(breadwheat)

```

## Preparing the data

We can convert this dataframe into a PlackettLuce rankings or grouped_rankings using the function `gosset::to_rankings`. A object of class "rankings"" is a matrix of dense rankings that can be used to fit a Plackett-Luce model using `PlackettLuce::PlackettLuce`. A object of class "grouped_rankings"" associates a group index with an object of class "rankings", then allows the rankings to be linked to covariates and fit a PlackettLuce model using `PlackettLuce::pltree`. 

Let's see how it works. We can convert the `breadwheat` data into a rankings object using the function `gosset::to_rankings`. The argument `grouped.rankings` return a object of class "grouped_rankings".

```{r, message = FALSE}
# this return a object of class "rankings"
R <- to_rankings(breadwheat, 
                 items = c(1:3), 
                 rankings = c(7:8),
                 type = "tricot")

print(R[1:10])

# and this a object of class "grouped_rankings"
G <- to_rankings(breadwheat, 
                 items = c(1:3), 
                 rankings = c(7:8),
                 type = "tricot",
                 grouped.rankings = TRUE)

print(G[1:10])

# you can also use the function PlackettLuce::grouped_rankings on the object R

G <- PlackettLuce::grouped_rankings(R, index = seq_len(nrow(R)))

print(G[1:10])

```

## Plackett Luce model
Let's fit a PlackettLuce model without covariates, using `PlackettLuce::PlackettLuce`

```{r, message = FALSE}
mod <- PlackettLuce::PlackettLuce(R)

print(mod)

```

## Model with covariates

And then, we fit a model with covariates. But first, let's get some covariates using the related temperature data `breadwheat_modis`, which contains the MODIS data (day and night temperatur) for all plots in `breadwheat` data from the planting date until the end of the the experiment. We use the function `gosset::temperature` to get the heat stress indices. An explanation about each index is found in `help(temperature)`.

```{r, message = FALSE}
data("breadwheat_modis", package = "gosset")

# get some variables to include in the model
# the timespan will be from the planting date to maturity (120 days)
covars <- temperature(breadwheat_modis,
                      day.one = breadwheat$planting_date,
                      span = 120)
# combine the grouped_rankings and the covariates
data <- cbind(G, covars)

head(data)

```


Now we fit the model using the function `PlackettLuce::pltree` with all covariates and defining a minimum size per node of 100 observations and a alpha of 0.05.

```{r, message = FALSE}
tree <- pltree(G ~ ., data = data, minsize = 100, alpha = 0.05)

print(tree)

```

## Tree visualisation

Here I show some ways to visualise the PlackettLuce tree. First we can use the print method from partykit as a default.

```{r, message = FALSE}

plot(tree)

```

We can also use the function `gosset::plot_nodes` which uses `ggplot2` to plot the quasi-variance coefficients with error bars from `qvcalc::qvcalc`.

**Note:**The function needs improvement. All help is welcome.

```{r, message = FALSE}

plots <- plot_nodes(tree)

cowplot::plot_grid(plots[[1]],
                   plots[[2]],
                   plots[[3]], ncol = 3, align = "h")

```



