---
title: "Analyse the ClimMob tricot data with PlackettLuce models"
author: "KauÃª de Sousa"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

# Breadwheat data

Here I show an example using the `breadwheat` data. Which is a dataframe with data from crowdsourcing citizen-science trials of bread wheat (*Triticum aestivum*) varieties in India. We fetch the data from ClimMob using the function `getDataCM`.

```{r, message = FALSE}
#library("devtools")
#install_github("kauedesousa/ClimMobTools", upgrade = "never")
library("ClimMobTools")
#install_github("kauedesousa/gosset", upgrade = "never")
library("gosset")
library("PlackettLuce")
library("tidyverse")
library("magrittr")

# read the data and organise it in the wide format
key <- "d39a3c66-5822-4930-a9d4-50e7da041e77"

data <- ClimMobTools::getDataCM(key = key, 
                                project = "breadwheat")

# put it in wide format
data <- data[,-2]

data <- data[!grepl("survey", data$variable), ]

data %<>%
  group_by(., id) %>%
  distinct(., id, variable, value)

data <- tidyr::spread(data, variable, value)

```

## Preparing the data

We can convert this dataframe into a PlackettLuce rankings or grouped_rankings using the function `gosset::to_rankings`. A object of class "rankings"" is a matrix of dense rankings that can be used to fit a Plackett-Luce model using `PlackettLuce::PlackettLuce`. A object of class "grouped_rankings"" associates a group index with an object of class "rankings", then allows the rankings to be linked to covariates and fit a PlackettLuce model using `PlackettLuce::pltree`. 

Let's see how it works. We can convert the `breadwheat` data into a rankings object using the function `gosset::to_rankings`. The argument `grouped.rankings` return a object of class "grouped_rankings".

```{r, message = FALSE}
# this return a object of class "rankings"
R <- to_rankings(data, 
                 items = c("item_A","item_B","item_C"), 
                 rankings = c("overallperf_pos","overallperf_neg"),
                 type = "tricot")

print(R[1:10])

# and this a object of class "grouped_rankings"
G <- to_rankings(data, 
                 items = c("item_A","item_B","item_C"), 
                 rankings = c("overallperf_pos","overallperf_neg"),
                 type = "tricot")

print(G[1:10])

# you can also use the function PlackettLuce::grouped_rankings on the object R

G <- PlackettLuce::grouped_rankings(R, index = seq_len(nrow(R)))

print(G[1:10])

```

## Plackett Luce model
Let's fit a PlackettLuce model without covariates, using `PlackettLuce::PlackettLuce`

```{r, message = FALSE}
mod <- PlackettLuce::PlackettLuce(R)

print(mod)

```

## Model with covariates

And then, we fit a model with covariates. But first, let's get some covariates using the function `gosset::temperature`, which fetch the temperature data from NASA Power and calculates the heat stress indices.

```{r, message = FALSE}
# planting dates into an object of class "Date"
pdates <- as.Date(data[["plantingdate"]], format = "%Y-%m-%d")

# coordinates into numeric
coords <- apply(data[c("lon","lat")], 2, as.numeric)

# get some variables to include in the model
# the timespan will be from the planting date to maturity (120 days)
covars <- temperature(coords, 
                      day.one = pdates, 
                      span = 120)

# combine the grouped_rankings and the covariates
data <- cbind(G, covars)

head(data)

```


Now we fit the model using the function `PlackettLuce::pltree` with all covariates and defining a minimum size per node of 100 observations and a alpha of 0.05.

```{r, message = FALSE}
tree <- pltree(G ~ ., data = data, minsize = 100, alpha = 0.05)

print(tree)

```
